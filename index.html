<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Model Atom 3D — AR Markerless (Fixed Imports)</title>
  <style>
    :root{--bg:#0f1724;--panel:#071427;--accent:#7dd3fc;--text:#e6eef8}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#051025 0%,#081827 100%);color:var(--text);font-family:Inter,system-ui,Arial}
    #ui{position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.45);padding:10px;border-radius:8px;z-index:5}
    button{background:var(--accent);color:#00121a;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    #msg{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.45);padding:8px;border-radius:6px;font-size:13px}
    canvas{display:block}
  </style>
</head>
<body>
  <div id="ui">
    <button id="resetBtn">Reset Kamera</button>
  </div>
  <div id="msg">Memuat... jika AR tak tersedia, gunakan mode 3D biasa.</div>

  <!-- Use non-module builds so example files don't import bare 'three' specifiers -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/webxr/ARButton.js"></script>

  <script>
    // Defensive checks
    if (typeof THREE === 'undefined') {
      document.getElementById('msg').textContent = 'Gagal memuat Three.js. Periksa koneksi CDN.';
      throw new Error('THREE not loaded');
    }

    // Basic scene setup (same visuals as your model)
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 50);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Add AR button if possible (ARButton provided by examples/js/webxr/ARButton.js as global ARButton)
    try {
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));
    } catch (err) {
      // If ARButton isn't available or fails, show a message and continue in non-AR mode
      console.warn('ARButton error:', err);
      document.getElementById('msg').textContent = 'AR tidak tersedia pada perangkat ini — menampilkan viewer 3D saja.';
    }

    // Lighting
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(5, 10, 7); scene.add(dir);

    // Grid (faint)
    const grid = new THREE.GridHelper(40, 40, 0x123044, 0x09121a);
    grid.position.y = -2; scene.add(grid);

    // Atom model (same as your non-AR model)
    const params = { speed: 1, nucleusScale: 1, trail: false };
    const nucleusGroup = new THREE.Group(); scene.add(nucleusGroup);
    const electronsGroup = new THREE.Group(); scene.add(electronsGroup);
    const orbitsGroup = new THREE.Group(); scene.add(orbitsGroup);

    const protonMat = new THREE.MeshStandardMaterial({ color: 0xff6666, metalness: 0.2, roughness: 0.6 });
    const neutronMat = new THREE.MeshStandardMaterial({ color: 0x9999ff, metalness: 0.2, roughness: 0.6 });
    const electronMat = new THREE.MeshStandardMaterial({ color: 0x7dd3fc, emissive: 0x003b4d });
    const orbitMat = new THREE.LineBasicMaterial({ color: 0x3a6f88, linewidth: 1, opacity: 0.6, transparent: true });

    function buildSimpleAtom(){
      // clear groups
      while(nucleusGroup.children.length) nucleusGroup.remove(nucleusGroup.children[0]);
      while(electronsGroup.children.length) electronsGroup.remove(electronsGroup.children[0]);
      while(orbitsGroup.children.length) orbitsGroup.remove(orbitsGroup.children[0]);

      // nucleus - a small visual core
      const core = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({ color: 0xff4444 }));
      nucleusGroup.add(core);

      // simple electron set
      const shellRadii = [0.9, 1.6];
      for (let s = 0; s < 2; s++){
        const r = shellRadii[s];
        const curve = new THREE.EllipseCurve(0,0,r,r,0,Math.PI*2,false,0);
        const points = curve.getPoints(64).map(p => new THREE.Vector3(p.x, 0, p.y));
        const geo = new THREE.BufferGeometry().setFromPoints(points);
        const orbitLine = new THREE.LineLoop(geo, orbitMat); orbitLine.rotation.x = Math.PI/2; orbitsGroup.add(orbitLine);

        const count = (s===0)?2:4;
        for(let i=0;i<count;i++){
          const theta = (i/count)*Math.PI*2;
          const e = new THREE.Mesh(new THREE.SphereGeometry(0.06, 12, 12), electronMat);
          e.userData = { angle: theta, radius: r, speed: 0.6 + 0.4*s };
          e.position.set(r*Math.cos(theta), 0, r*Math.sin(theta));
          electronsGroup.add(e);
        }
      }
    }
    buildSimpleAtom();

    // Add OrbitControls for non-AR interaction (these scripts attach OrbitControls to THREE namespace)
    let controls;
    try {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      camera.position.set(0, 1.6, 3);
      controls.update();
    } catch (err) {
      console.warn('OrbitControls not available', err);
    }

    // AR hit-test / reticle
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    const reticleGeo = new THREE.RingGeometry(0.12, 0.15, 32);
    reticleGeo.rotateX(-Math.PI / 2);
    const reticleMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
    const reticle = new THREE.Mesh(reticleGeo, reticleMat);
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // Animation loop
    function animate(){
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame){
      // animate electrons
      electronsGroup.children.forEach(function(el){
        el.userData.angle += 0.01 * params.speed;
        const r = el.userData.radius;
        el.position.set(r * Math.cos(el.userData.angle), 0, r * Math.sin(el.userData.angle));
      });

      // AR hit-test: only when in XR session and frame available
      if(frame){
        const session = renderer.xr.getSession();
        const referenceSpace = renderer.xr.getReferenceSpace();

        if(!hitTestSourceRequested){
          // request a hit test source for viewer
          session.requestReferenceSpace('viewer').then(function(viewerRef){
            session.requestHitTestSource({ space: viewerRef }).then(function(source){
              hitTestSource = source;
            });
          });

          session.addEventListener('end', function(){
            hitTestSourceRequested = false;
            hitTestSource = null;
            reticle.visible = false;
          });

          hitTestSourceRequested = true;
        }

        if(hitTestSource){
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if(hitTestResults.length > 0){
            const hit = hitTestResults[0];
            const pose = hit.getPose(referenceSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
      }

      renderer.render(scene, camera);
    }

    // Start animation
    animate();

    // Place atom on tap (or mouse click) when reticle visible
    window.addEventListener('click', function(){
      if(reticle.visible){
        const pos = new THREE.Vector3();
        pos.setFromMatrixPosition(reticle.matrix);
        // move entire atom groups to reticle
        nucleusGroup.position.copy(pos);
        electronsGroup.position.copy(pos);
        orbitsGroup.position.copy(pos);
        document.getElementById('msg').textContent = 'Model ditempatkan.';
      }
    });

    // Reset camera for non-AR mode
    document.getElementById('resetBtn').addEventListener('click', function(){
      if(controls){ controls.reset(); }
      camera.position.set(0,1.6,3);
      document.getElementById('msg').textContent = 'Kamera direset.';
    });

    // Resize
    window.addEventListener('resize', function(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Feature detection message
    if(navigator.xr){
      navigator.xr.isSessionSupported('immersive-ar').then(function(supported){
        if(supported) document.getElementById('msg').textContent = 'Perangkat mendukung WebXR AR — ketuk Enter AR untuk mulai.';
        else document.getElementById('msg').textContent = 'Perangkat tidak mendukung WebXR AR. Mode 3D biasa aktif.';
      }).catch(()=>{ document.getElementById('msg').textContent = 'Tidak dapat memeriksa dukungan WebXR.'; });
    } else {
      document.getElementById('msg').textContent = 'WebXR tidak tersedia — gunakan mode 3D biasa.';
    }
  </script>
</body>
</html>
